<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Bus Admin Portal</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        body { background-color: #f8f9fa; }
        .login-container { max-width: 400px; margin: 10% auto; padding: 2rem; background: white; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .dashboard-container { max-width: 1200px; margin: 2% auto; }
        #map { height: 500px; width: 100%; border-radius: 8px; margin-top: 1rem; border: 1px solid #ddd; }
        .autocomplete-suggestions { border: 1px solid #ddd; border-top: none; background: #fff; position: absolute; z-index: 999; max-height: 150px; overflow-y: auto; width: calc(100% - 24px); }
        .autocomplete-suggestion { padding: 8px; cursor: pointer; }
        .autocomplete-suggestion:hover { background: #f0f0f0; }
        #routeCitiesDisplay .badge { font-size: 0.9rem; padding: 0.5em 0.75em; }
    </style>
</head>
<body>

    {% if section == 'login' %}
    <div class="container">
        <div class="login-container text-center">
            <h3>ðŸšŒ Smart Bus Admin Login</h3>
            <hr>
            <form action="/login" method="post">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="username" name="username" placeholder="admin" required>
                    <label for="username">Username</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" name="password" placeholder="admin123" required>
                    <label for="password">Password</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2">Login</button>
            </form>
        </div>
    </div>
    {% endif %}

    {% if section == 'dashboard' %}
    <div class="container dashboard-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0">ðŸšŒ Admin Dashboard</h2>
            <a href="/logout" class="btn btn-outline-danger">Logout</a>
        </div>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="add-bus-tab" data-bs-toggle="tab" data-bs-target="#add-bus" type="button" role="tab">Add Bus</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-buses-tab" data-bs-toggle="tab" data-bs-target="#view-buses" type="button" role="tab">View Buses (Upcoming)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-buses-tab" data-bs-toggle="tab" data-bs-target="#manage-buses" type="button" role="tab">Manage Buses (Upcoming)</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active p-4 bg-white border border-top-0 rounded-bottom" id="add-bus" role="tabpanel">
                <form id="addBusForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="busNumber" class="form-label">Bus Number</label>
                            <input type="text" class="form-control" id="busNumber" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="numberPlate" class="form-label">Number Plate</label>
                            <input type="text" class="form-control" id="numberPlate" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="driverName" class="form-label">Driver Name</label>
                            <input type="text" class="form-control" id="driverName" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="password" class="form-label">Bus Login Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3 position-relative">
                            <label for="source" class="form-label">Source</label>
                            <input type="text" class="form-control" id="source" autocomplete="off" required>
                            <div id="sourceSuggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <div class="col-md-6 mb-3 position-relative">
                            <label for="destination" class="form-label">Destination</label>
                            <input type="text" class="form-control" id="destination" autocomplete="off" required>
                            <div id="destinationSuggestions" class="autocomplete-suggestions"></div>
                        </div>
                    </div>
                    <button type="button" id="findRoutesBtn" class="btn btn-secondary">Find Routes on Map</button>
                    <hr>
                    <div id="map"></div>
                    
                    <div id="routeCitiesDisplay" class="mt-3"></div>
                    
                    <div id="status" class="mt-3"></div>
                    <button type="submit" class="btn btn-primary mt-3 float-end">Submit Bus Details</button>
                </form>
            </div>

            <div class="tab-pane fade p-4 bg-white border border-top-0 rounded-bottom" id="view-buses" role="tabpanel">
                <p>Feature to list all registered buses from Backendless will be implemented here.</p>
            </div>
            <div class="tab-pane fade p-4 bg-white border border-top-0 rounded-bottom" id="manage-buses" role="tabpanel">
                <p>Feature to edit and delete buses will be implemented here.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    {% if section == 'dashboard' %}
    <script>
    $(document).ready(function() {
        const map = L.map('map').setView([14.4673, 78.8242], 9); // Centered on Kadapa District, India
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let sourceCoords, destCoords;
        let routeLayers = L.layerGroup().addTo(map);
        let selectedRouteLayer = null;
        let confirmedRouteCities = [];

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function setupAutocomplete(inputId, suggestionsId) {
            const input = $(inputId);
            const suggestions = $(suggestionsId);
            input.on('keyup', function() {
                const query = $(this).val();
                if (query.length < 3) { suggestions.hide().empty(); return; }
                $.get(`/api/autocomplete?q=${query}`, function(data) {
                    suggestions.empty().show();
                    data.features.forEach(feature => {
                        suggestions.append(`<div class="autocomplete-suggestion" data-lon="${feature.geometry.coordinates[0]}" data-lat="${feature.geometry.coordinates[1]}">${feature.properties.name}</div>`);
                    });
                });
            });
            suggestions.on('click', '.autocomplete-suggestion', function() {
                input.val($(this).text());
                if (inputId === '#source') { sourceCoords = { lon: $(this).data('lon'), lat: $(this).data('lat') }; } 
                else { destCoords = { lon: $(this).data('lon'), lat: $(this).data('lat') }; }
                suggestions.hide().empty();
            });
            $(document).on('click', e => { if (!$(e.target).closest(inputId + ', ' + suggestionsId).length) { suggestions.hide(); }});
        }

        setupAutocomplete('#source', '#sourceSuggestions');
        setupAutocomplete('#destination', '#destinationSuggestions');
        
        async function processAndDisplayRouteCities(layer) {
            $('#status').html('<div class="alert alert-info">Processing route... extracting intermediate stops.</div>');
            $('#routeCitiesDisplay').empty();
            confirmedRouteCities = [];

            const routeCoords = layer.toGeoJSON().geometry.coordinates;
            const routeCitiesSet = new Set();
            const sampleRate = Math.max(1, Math.floor(routeCoords.length / 20)); 

            for (let i = 0; i < routeCoords.length; i += sampleRate) {
                const [lon, lat] = routeCoords[i];
                try {
                    const response = await $.get(`/api/reverse_geocode?lat=${lat}&lon=${lon}`);
                    if (response.name) {
                        routeCitiesSet.add(response.name);
                    }
                    await delay(50);
                } catch (error) { console.error("Reverse geocoding error:", error); }
            }

            const rawPlaceNames = Array.from(routeCitiesSet);
            if (rawPlaceNames.length > 0) {
                confirmedRouteCities = rawPlaceNames.map((place, index) => `Stop ${index + 1}: ${place}`);
                let citiesHtml = '<h5>Intermediate Stops on Selected Route:</h5>';
                confirmedRouteCities.forEach(stopName => {
                    citiesHtml += `<span class="badge bg-secondary me-1 mb-1">${stopName}</span>`;
                });
                $('#routeCitiesDisplay').html(citiesHtml);
                $('#status').html('<div class="alert alert-success">Route processed. You can now submit the form.</div>');
            } else {
                $('#routeCitiesDisplay').html('<p class="text-muted">No specific intermediate stops could be identified on this route.</p>');
                $('#status').empty();
            }
        }

        $('#findRoutesBtn').on('click', function() {
            if (!sourceCoords || !destCoords) {
                $('#status').html('<div class="alert alert-warning">Please select a valid source and destination.</div>');
                return;
            }
            $('#status').html('<div class="alert alert-info">Fetching routes...</div>');
            $('#routeCitiesDisplay').empty();
            confirmedRouteCities = [];
            routeLayers.clearLayers();
            selectedRouteLayer = null;

            const start = `${sourceCoords.lon},${sourceCoords.lat}`;
            const end = `${destCoords.lon},${destCoords.lat}`;

            $.get(`/api/routes?start=${start}&end=${end}`, function(data) {
                if (data.features && data.features.length > 0) {
                     $('#status').html('<div class="alert alert-primary">Routes found! Click a route on the map to process it.</div>');
                    data.features.forEach((route, index) => {
                        L.geoJSON(route, {
                            style: { color: index === 0 ? '#0d6efd' : 'gray', weight: 5, opacity: 0.7 },
                            onEachFeature: function(feature, layer) {
                                layer.on('click', async function() {
                                    routeLayers.eachLayer(l => l.setStyle({ color: 'gray', weight: 5, opacity: 0.7 }));
                                    this.setStyle({ color: 'green', weight: 7, opacity: 1 });
                                    selectedRouteLayer = this;
                                    await processAndDisplayRouteCities(this);
                                });
                            }
                        }).addTo(routeLayers);
                    });
                    map.fitBounds(routeLayers.getBounds().pad(0.1));
                } else {
                    $('#status').html('<div class="alert alert-danger">Could not find any routes.</div>');
                }
            })
            // **THE FIX IS HERE**: Improved error handling to show detailed messages.
            .fail(function(jqXHR) {
                let errorMsg = "<strong>Error fetching routes.</strong>";
                if (jqXHR.responseJSON && jqXHR.responseJSON.details) {
                    // Try to parse the error message from the mapping service
                    try {
                        const orsError = JSON.parse(jqXHR.responseJSON.details);
                        if (orsError && orsError.error && orsError.error.message) {
                            errorMsg += `<br><small>Reason: ${orsError.error.message}</small>`;
                        } else {
                             errorMsg += `<br><small>Server Response: ${jqXHR.responseJSON.details}</small>`;
                        }
                    } catch(e) {
                        errorMsg += `<br><small>Server Response: ${jqXHR.responseJSON.details}</small>`;
                    }
                }
                $('#status').html(`<div class="alert alert-danger">${errorMsg}</div>`);
            });
        });

        $('#addBusForm').on('submit', function(e) {
            e.preventDefault();
            if (!selectedRouteLayer) {
                $('#status').html('<div class="alert alert-danger">Please find and select a route on the map first.</div>');
                return;
            }

            const busData = {
                busNumber: $('#busNumber').val(),
                numberPlate: $('#numberPlate').val(),
                driverName: $('#driverName').val(),
                password: $('#password').val(),
                source: $('#source').val(),
                destination: $('#destination').val(),
                routeCities: confirmedRouteCities
            };
            
            $('#status').html('<div class="alert alert-info">Submitting data to the database...</div>');

            $.ajax({
                url: '/api/add_bus',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(busData),
                success: function(response) {
                    $('#status').html('<div class="alert alert-success">Bus added successfully! Object ID: ' + response.objectId + '</div>');
                    $('#addBusForm')[0].reset();
                    routeLayers.clearLayers();
                    selectedRouteLayer = null;
                    $('#routeCitiesDisplay').empty();
                    confirmedRouteCities = [];
                },
                error: function(xhr) {
                    $('#status').html('<div class="alert alert-danger">Failed to add bus. Server said: ' + xhr.responseText + '</div>');
                }
            });
        });
    });
    </script>
    {% endif %}

</body>
</html>