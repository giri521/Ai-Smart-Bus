<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-Enabled Bus Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        html, body { overflow: hidden; height: 100%; width: 100%; }
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .message { margin-bottom: 1rem; display: flex; flex-direction: column; }
        .bot-message .message-content { background-color: #e5e7eb; align-self: flex-start; }
        .user-message .message-content { background-color: #3b82f6; color: white; align-self: flex-end; }
        .message-content { padding: 0.75rem 1rem; border-radius: 0.75rem; max-width: 95%; line-height: 1.5; }
        #map { height: 100%; width: 100%; border-radius: 0.5rem; z-index: 0; }
        .search-again-btn { background-color: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; margin-top: 0.75rem; cursor: pointer; font-weight: 500; }
        .search-again-btn:hover { background-color: #059669; }
        .details-list { list-style: none; padding: 0; margin: 0; }
        .details-list li { padding: 0.3rem 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; }
        .details-list li:last-child { border-bottom: none; }
        .details-list li strong { margin-right: 1rem; color: #4b5563; font-size: 0.9rem; }
        .details-list-value { text-align: right; font-weight: 500; }
        .section-title { font-weight: 700; font-size: 1.1rem; color: #1f2937; padding-bottom: 0.5rem; margin-top: 0.75rem; margin-bottom: 0.5rem; border-bottom: 2px solid #d1d5db; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .info-card { background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; text-align: center;}
        .info-card h3 { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem; }
        .info-card p { font-size: 1rem; font-weight: 700; }
        #mic-btn {
            background-color: #6b7280; color: white; border: none; border-radius: 0.5rem; width: 52px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s;
        }
        #mic-btn:hover { background-color: #4b5563; }
        #mic-btn.is-listening { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full h-screen max-w-screen-2xl mx-auto flex p-4 gap-4">
        <div class="w-full md:w-1/3 lg:w-1/3 flex flex-col bg-white rounded-lg shadow-2xl chat-container">
            <header class="bg-gray-800 text-white p-4 rounded-t-lg flex justify-between items-center flex-shrink-0">
                <h1 class="text-xl font-bold">Bus Assistant</h1>
                <div>
                    <select id="language-select" class="bg-gray-700 text-white rounded-md p-1 text-sm">
                        <option value="en-IN">English</option>
                        <option value="hi-IN">Hindi</option>
                        <option value="te-IN">Telugu</option>
                        <option value="ta-IN">Tamil</option>
                    </select>
                </div>
            </header>
            <div id="chat-messages" class="chat-messages"></div>
            <footer class="p-4 border-t flex-shrink-0">
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="Ask or tap the mic..." class="flex-grow border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none disabled:bg-gray-200">
                    <button id="mic-btn" title="Ask with voice">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    </button>
                    <button id="send-btn" class="bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-700 disabled:bg-blue-400">Send</button>
                </div>
            </footer>
        </div>
        <div id="map" class="w-full md:w-2/3 lg:w-2/3 h-[calc(100vh-2rem)] rounded-lg shadow-2xl"></div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const BACKENDLESS_APP_ID = '7A748A24-7BDE-48E4-B794-E1F6CF1E9CF2';
        const BACKENDLESS_API_KEY = '4F8AE28B-AB86-40D7-94FB-6F1BF8C639E6';
        const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjFhYTUzNzY1MTE2ODFiZDRmNmJmMTMyMmM4N2FjYTJiZmRjNDQ1YTRlYjAyNTg2MzJkZjdlMjkzIiwiaCI6Im11cm11cjY0In0=';

        // --- DOM ELEMENTS & SPEECH API SETUP ---
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const langSelect = document.getElementById('language-select');
        const micBtn = document.getElementById('mic-btn');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
        } else {
            micBtn.style.display = 'none';
        }
        
        // --- GLOBAL STATE ---
        let userLocation = null;
        let currentBusData = null;
        let trackingInterval = null;
        let mapInstance = null;
        let userMarker = null;
        let busMarker = null;
        let stopMarker = null;
        let routeLayers = L.layerGroup();
        
        // --- TRANSLATIONS ---
        const placeNameTranslations = {
            'Madurai': { 'hi-IN': '‡§Æ‡§¶‡•Å‡§∞‡•à', 'te-IN': '‡∞Æ‡∞ß‡±Å‡∞∞‡±à', 'ta-IN': '‡ÆÆ‡Æ§‡ØÅ‡Æ∞‡Øà' },
            'Rajapalayam': { 'hi-IN': '‡§∞‡§æ‡§ú‡§æ‡§™‡§≤‡§æ‡§Ø‡§Æ', 'te-IN': '‡∞∞‡∞æ‡∞ú‡∞™‡∞æ‡∞≤‡∞Ø‡∞Ç', 'ta-IN': '‡Æ∞‡Ææ‡Æú‡Æ™‡Ææ‡Æ≥‡Øà‡ÆØ‡ÆÆ‡Øç' },
            'Srivilliputhur': { 'hi-IN': '‡§∂‡•ç‡§∞‡•Ä‡Æµ‡Æø‡Æ≤‡Øç‡§≤‡§ø‡§™‡•Å‡§•‡•Å‡§∞', 'te-IN': '‡∞∂‡±ç‡∞∞‡±Ä‡∞µ‡∞ø‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡±Å‡∞§‡±ç‡∞§‡±Ç‡∞∞‡±Å', 'ta-IN': '‡Æ∏‡Øç‡Æ∞‡ØÄ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Æø‡Æ™‡ØÅ‡Æ§‡Øç‡Æ§‡ØÇ‡Æ∞‡Øç' }
        };

        const numberWords = {
            // English
            'one': '1', 'two': '2', 'three': '3', 'four': '4', 'five': '5', 'six': '6', 'seven': '7', 'eight': '8', 'nine': '9', 'ten': '10',
            // Hindi
            '‡§è‡§ï': '1', '‡§¶‡•ã': '2', '‡§§‡•Ä‡§®': '3', '‡§ö‡§æ‡§∞': '4', '‡§™‡§æ‡§Ç‡§ö': '5', '‡§õ‡§π': '6', '‡§∏‡§æ‡§§': '7', '‡§Ü‡§†': '8', '‡§®‡•å': '9', '‡§¶‡§∏': '10',
            // Telugu
            '‡∞í‡∞ï‡∞ü‡∞ø': '1', '‡∞∞‡±Ü‡∞Ç‡∞°‡±Å': '2', '‡∞Æ‡±Ç‡∞°‡±Å': '3', '‡∞®‡∞æ‡∞≤‡±Å‡∞ó‡±Å': '4', '‡∞ê‡∞¶‡±Å': '5', '‡∞Ü‡∞∞‡±Å': '6', '‡∞è‡∞°‡±Å': '7', '‡∞é‡∞®‡∞ø‡∞Æ‡∞ø‡∞¶‡∞ø': '8', '‡∞§‡±ä‡∞Æ‡±ç‡∞Æ‡∞ø‡∞¶‡∞ø': '9', '‡∞™‡∞¶‡∞ø': '10', '‡∞µ‡∞®‡±ç': '1',
            // Tamil
            '‡Æí‡Æ©‡Øç‡Æ±‡ØÅ': '1', '‡Æá‡Æ∞‡Æ£‡Øç‡Æü‡ØÅ': '2', '‡ÆÆ‡ØÇ‡Æ©‡Øç‡Æ±‡ØÅ': '3', '‡Æ®‡Ææ‡Æ©‡Øç‡Æï‡ØÅ': '4', '‡Æê‡Æ®‡Øç‡Æ§‡ØÅ': '5', '‡ÆÜ‡Æ±‡ØÅ': '6', '‡Æè‡Æ¥‡ØÅ': '7', '‡Æé‡Æü‡Øç‡Æü‡ØÅ': '8', '‡Æí‡Æ©‡Øç‡Æ™‡Æ§‡ØÅ': '9', '‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ': '10'
        };

        const translations = {
            'en-IN': {
                welcome: "Welcome! Tap the mic or enter a bus number.", searching: "Hold on, I'm checking for that bus number...", no_bus: "Sorry, no bus was found with that number.", bus_found: "Great! I found the bus. Here is its live status:", direct_dist_message: "üöç...üßçThe bus is approx. <strong>{distance} km</strong> away. Estimated driving time to it is <strong>{time} minutes</strong>.", bus_arriving_message: "The bus is arriving at your location now!", bus_details_title: "Bus #{busNumber} Details", intercept_plan_title: "Intercept Plan üó∫Ô∏è", intercept_stop_message: "The best upcoming stop for you to catch the bus is: <strong>{stopName}</strong>", eta_user: "You to Stop", eta_bus: "Bus to Stop", search_again: "Search Again", getting_location: "Getting your location...", location_confirmed: "I've detected your location near <strong>{city}</strong>. You can now search for a bus.", location_error: "Could not get your location. Please grant permission and refresh.", no_live_location: "This bus was found, but it's not broadcasting its live location right now.", bus_not_active: "Bus {busNumber} was found, but it is currently not in service. Its status is: {status}.", last_updated: "Last Updated", driver_name: "Driver", driver_mobile: "Driver Mobile", available_seats: "Available Seats", total_seats: "Total Seats", route: "Route", number_plate: "Vehicle No.", weather: "Weather", need_bus_context: "Please find a bus first before asking about its details.", not_provided: "Not provided", sms_title: "Get SMS Updates üì±", phone_placeholder: "Enter your phone number...", sms_btn_text: "Send SMS", sending_sms: "Sending...", sms_sent: "‚úÖ SMS sent successfully!", sms_error: "‚ùå Could not send SMS. Please try again.", unrecognized_bus_number: "I didn't recognize a bus number. Please try again."
            },
            'hi-IN': {
                welcome: "‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! ‡§¨‡§∏ ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ç‡§õ‡•á‡§Ç, ‡§Ø‡§æ ‡§¨‡•ã‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§æ‡§á‡§ï ‡§™‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§", searching: "‡§∞‡•Å‡§ï‡§ø‡§è, ‡§Æ‡•à‡§Ç ‡§â‡§∏ ‡§¨‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...", no_bus: "‡§Æ‡§æ‡§´‡§º ‡§ï‡•Ä‡§ú‡§ø‡§è, ‡§Æ‡•Å‡§ù‡•á ‡§â‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•ã‡§à ‡§¨‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§", bus_found: "‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§Æ‡•Å‡§ù‡•á ‡§¨‡§∏ ‡§Æ‡§ø‡§≤ ‡§ó‡§à‡•§ ‡§Ø‡§π‡§æ‡§Å ‡§á‡§∏‡§ï‡•Ä ‡§≤‡§æ‡§á‡§µ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§π‡•à:", direct_dist_message: "üöç...üßç‡§¨‡§∏ ‡§Ü‡§™‡§∏‡•á ‡§≤‡§ó‡§≠‡§ó <strong>{distance} ‡§ï‡§ø‡§Æ‡•Ä</strong> ‡§¶‡•Ç‡§∞ ‡§π‡•à‡•§ ‡§µ‡§π‡§æ‡§Ç ‡§§‡§ï ‚Äã‚Äã‡§™‡§π‡•Å‡§Ç‡§ö‡§®‡•á ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§∏‡§Æ‡§Ø <strong>{time} ‡§Æ‡§ø‡§®‡§ü</strong> ‡§π‡•à‡•§", bus_arriving_message: "‡§¨‡§∏ ‡§Ö‡§¨ ‡§Ü‡§™‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§∞ ‡§™‡§π‡•Å‡§Ç‡§ö ‡§∞‡§π‡•Ä ‡§π‡•à!", bus_details_title: "‡§¨‡§∏ #{busNumber} ‡§µ‡§ø‡§µ‡§∞‡§£", intercept_plan_title: "‡§á‡§Ç‡§ü‡§∞‡§∏‡•á‡§™‡•ç‡§ü ‡§™‡•ç‡§≤‡§æ‡§® üó∫Ô∏è", intercept_stop_message: "‡§¨‡§∏ ‡§™‡§ï‡§°‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∏‡•ç‡§ü‡•â‡§™ ‡§π‡•à: <strong>{stopName}</strong>", eta_user: "‡§Ü‡§™‡§ï‡•Ä ‡§∏‡•ç‡§ü‡•â‡§™ ‡§§‡§ï", eta_bus: "‡§¨‡§∏ ‡§ï‡•Ä ‡§∏‡•ç‡§ü‡•â‡§™ ‡§§‡§ï", search_again: "‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ñ‡•ã‡§ú‡•á‡§Ç", getting_location: "‡§Ü‡§™‡§ï‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§≤‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...", location_confirmed: "‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§™‡§ï‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® <strong>{city}</strong> ‡§ï‡•á ‡§™‡§æ‡§∏ ‡§™‡§æ‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ö‡§¨ ‡§Ü‡§™ ‡§¨‡§∏ ‡§ñ‡•ã‡§ú ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§", location_error: "‡§Ü‡§™‡§ï‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§™‡•á‡§ú ‡§ï‡•ã ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§", no_live_location: "‡§Ø‡§π ‡§¨‡§∏ ‡§Æ‡§ø‡§≤ ‡§ó‡§à ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ö‡§≠‡•Ä ‡§á‡§∏‡§ï‡§æ ‡§≤‡§æ‡§á‡§µ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‡•§", bus_not_active: "‡§¨‡§∏ {busNumber} ‡§Æ‡§ø‡§≤ ‡§ó‡§à, ‡§≤‡•á‡§ï‡§ø‡§® ‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§á‡§∏‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§π‡•à: {status}‡•§", last_updated: "‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü", driver_name: "‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞", driver_mobile: "‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤", available_seats: "‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§∏‡•Ä‡§ü‡•á‡§Ç", total_seats: "‡§ï‡•Å‡§≤ ‡§∏‡•Ä‡§ü‡•á‡§Ç", route: "‡§Æ‡§æ‡§∞‡•ç‡§ó", number_plate: "‡§ó‡§æ‡§°‡§º‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ", weather: "‡§Æ‡•å‡§∏‡§Æ", need_bus_context: "‡§¨‡§∏ ‡§ï‡•á ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§¨‡§∏ ‡§ñ‡•ã‡§ú‡•á‡§Ç‡•§", not_provided: "‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ", sms_title: "‡§è‡§∏‡§è‡§Æ‡§è‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç üì±", phone_placeholder: "‡§Ö‡§™‡§®‡§æ ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç...", sms_btn_text: "‡§è‡§∏‡§è‡§Æ‡§è‡§∏ ‡§≠‡•á‡§ú‡•á‡§Ç", sending_sms: "‡§≠‡•á‡§ú ‡§∞‡§π‡§æ ‡§π‡•à...", sms_sent: "‚úÖ ‡§è‡§∏‡§è‡§Æ‡§è‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ!", sms_error: "‚ùå ‡§è‡§∏‡§è‡§Æ‡§è‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", unrecognized_bus_number: "‡§Æ‡•à‡§Ç‡§®‡•á ‡§¨‡§∏ ‡§®‡§Ç‡§¨‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§™‡§π‡§ö‡§æ‡§®‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø‡•§"
            },
            'te-IN': {
                welcome: "‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç! ‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‚Äå‡∞®‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø ‡∞≤‡±á‡∞¶‡∞æ ‡∞Æ‡∞æ‡∞ü‡±ç‡∞≤‡∞æ‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Æ‡±à‡∞ï‡±ç‚Äå‡∞®‡±Å ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø.", searching: "‡∞í‡∞ï‡±ç‡∞ï ‡∞®‡∞ø‡∞Æ‡∞ø‡∞∑‡∞Ç, ‡∞®‡±á‡∞®‡±Å ‡∞Ü ‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞§‡∞®‡∞ø‡∞ñ‡±Ä ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å...", no_bus: "‡∞ï‡±ç‡∞∑‡∞Æ‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø, ‡∞Ü ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‚Äå‡∞§‡±ã ‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞¨‡∞°‡∞≤‡±á‡∞¶‡±Å.", bus_found: "‡∞ó‡±ä‡∞™‡±ç‡∞™‡∞¶‡∞ø! ‡∞®‡±á‡∞®‡±Å ‡∞¨‡∞∏‡±ç‡∞∏‡±Å‡∞®‡±Å ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å. ‡∞¶‡∞æ‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞∏‡±ç‡∞•‡∞ø‡∞§‡∞ø ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞â‡∞Ç‡∞¶‡∞ø:", direct_dist_message: "üöç...üßç‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞∏‡±Å‡∞Æ‡∞æ‡∞∞‡±Å <strong>{distance} ‡∞ï‡∞ø.‡∞Æ‡±Ä</strong> ‡∞¶‡±Ç‡∞∞‡∞Ç‡∞≤‡±ã ‡∞â‡∞Ç‡∞¶‡∞ø. ‡∞¶‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞°‡±ç‡∞∞‡±à‡∞µ‡∞ø‡∞Ç‡∞ó‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ ‡∞∏‡∞Æ‡∞Ø‡∞Ç <strong>{time} ‡∞®‡∞ø‡∞Æ‡∞ø‡∞∑‡∞æ‡∞≤‡±Å</strong>.", bus_arriving_message: "‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±Å ‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡∞¶‡±á‡∞∂‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞µ‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø!", bus_details_title: "‡∞¨‡∞∏‡±ç‡∞∏‡±Å #{busNumber} ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å", intercept_plan_title: "‡∞á‡∞Ç‡∞ü‡∞∞‡±ç‚Äå‡∞∏‡±Ü‡∞™‡±ç‡∞ü‡±ç ‡∞™‡±ç‡∞≤‡∞æ‡∞®‡±ç üó∫Ô∏è", intercept_stop_message: "‡∞Æ‡±Ä‡∞∞‡±Å ‡∞¨‡∞∏‡±ç‡∞∏‡±Å‡∞®‡±Å ‡∞™‡∞ü‡±ç‡∞ü‡±Å‡∞ï‡±ã‡∞µ‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞â‡∞§‡±ç‡∞§‡∞Æ‡∞Æ‡±à‡∞® ‡∞∞‡∞æ‡∞¨‡±ã‡∞Ø‡±á ‡∞∏‡±ç‡∞ü‡∞æ‡∞™‡±ç: <strong>{stopName}</strong>", eta_user: "‡∞Æ‡±Ä‡∞∞‡±Å ‡∞∏‡±ç‡∞ü‡∞æ‡∞™‡±ç‚Äå‡∞ï‡±Å", eta_bus: "‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞∏‡±ç‡∞ü‡∞æ‡∞™‡±ç‚Äå‡∞ï‡±Å", search_again: "‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞∂‡±ã‡∞ß‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø", getting_location: "‡∞Æ‡±Ä ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞™‡±ä‡∞Ç‡∞¶‡±Å‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å...", location_confirmed: "‡∞®‡±á‡∞®‡±Å ‡∞Æ‡±Ä ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç‚Äå‡∞®‡±Å <strong>{city}</strong> ‡∞∏‡∞Æ‡±Ä‡∞™‡∞Ç‡∞≤‡±ã ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞æ‡∞®‡±Å. ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±Å ‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞∂‡±ã‡∞ß‡∞ø‡∞Ç‡∞ö‡∞µ‡∞ö‡±ç‡∞ö‡±Å.", location_error: "‡∞Æ‡±Ä ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç‚Äå‡∞®‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞≤‡±á‡∞ï‡∞™‡±ã‡∞Ø‡∞æ‡∞®‡±Å. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Ö‡∞®‡±Å‡∞Æ‡∞§‡∞ø ‡∞á‡∞ö‡±ç‡∞ö‡∞ø, ‡∞∞‡∞ø‡∞´‡±ç‡∞∞‡±Ü‡∞∑‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.", no_live_location: "‡∞à ‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø, ‡∞ï‡∞æ‡∞®‡±Ä ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞¶‡∞æ‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡∞§‡±ç‡∞Ø‡∞ï‡±ç‡∞∑ ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç‚Äå‡∞®‡±Å ‡∞™‡±ç‡∞∞‡∞∏‡∞æ‡∞∞‡∞Ç ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç ‡∞≤‡±á‡∞¶‡±Å.", bus_not_active: "‡∞¨‡∞∏‡±ç‡∞∏‡±Å {busNumber} ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø, ‡∞ï‡∞æ‡∞®‡±Ä ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞∏‡±á‡∞µ‡∞≤‡±ã ‡∞≤‡±á‡∞¶‡±Å. ‡∞¶‡∞æ‡∞®‡∞ø ‡∞∏‡±ç‡∞•‡∞ø‡∞§‡∞ø: {status}.", last_updated: "‡∞ö‡∞ø‡∞µ‡∞∞‡∞ø‡∞ó‡∞æ ‡∞®‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø", driver_name: "‡∞°‡±ç‡∞∞‡±à‡∞µ‡∞∞‡±ç", driver_mobile: "‡∞°‡±ç‡∞∞‡±à‡∞µ‡∞∞‡±ç ‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç", available_seats: "‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞® ‡∞∏‡±Ä‡∞ü‡±ç‡∞≤‡±Å", total_seats: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞∏‡±Ä‡∞ü‡±ç‡∞≤‡±Å", route: "‡∞Æ‡∞æ‡∞∞‡±ç‡∞ó‡∞Ç", number_plate: "‡∞µ‡∞æ‡∞π‡∞®‡∞Ç ‡∞®‡∞Ç.", weather: "‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç", need_bus_context: "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞¶‡∞æ‡∞®‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤ ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ø‡∞ó‡±á ‡∞Æ‡±Å‡∞Ç‡∞¶‡±Å ‡∞¨‡∞∏‡±ç‡∞∏‡±Å‡∞®‡±Å ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞Ç‡∞°‡∞ø.", not_provided: "‡∞Ö‡∞Ç‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞≤‡±á‡∞¶‡±Å", sms_title: "SMS ‡∞®‡∞µ‡±Ä‡∞ï‡∞∞‡∞£‡∞≤‡∞®‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø üì±", phone_placeholder: "‡∞Æ‡±Ä ‡∞´‡±ã‡∞®‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‚Äå‡∞®‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø...", sms_btn_text: "SMS ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø", sending_sms: "‡∞™‡∞Ç‡∞™‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...", sms_sent: "‚úÖ SMS ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞™‡∞Ç‡∞™‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!", sms_error: "‚ùå SMS ‡∞™‡∞Ç‡∞™‡∞°‡∞Ç‡∞≤‡±ã ‡∞µ‡∞ø‡∞´‡∞≤‡∞Æ‡±à‡∞Ç‡∞¶‡∞ø. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.", unrecognized_bus_number: "‡∞®‡±á‡∞®‡±Å ‡∞¨‡∞∏‡±ç‡∞∏‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‚Äå‡∞®‡±Å ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞≤‡±á‡∞¶‡±Å. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø."
            },
            'ta-IN': {
                welcome: "‡Æµ‡Ææ‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç! ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æé‡Æ£‡Øç‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Øá‡Æö ‡ÆÆ‡Øà‡Æï‡Øç‡Æï‡Øà‡Æ§‡Øç ‡Æ§‡Æü‡Øç‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç.", searching: "‡Æ™‡Øä‡Æ±‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç, ‡ÆÖ‡Æ®‡Øç‡Æ§ ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æé‡Æ£‡Øç‡Æ£‡Øà‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...", no_bus: "‡ÆÆ‡Æ©‡Øç‡Æ©‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç, ‡ÆÖ‡Æ®‡Øç‡Æ§ ‡Æé‡Æ£‡Øç‡Æ£‡Æø‡Æ≤‡Øç ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æé‡Æ§‡ØÅ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", bus_found: "‡ÆÖ‡Æ∞‡ØÅ‡ÆÆ‡Øà! ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Æ£‡Øç‡Æü‡ØÅ‡Æ™‡Æø‡Æü‡Æø‡Æ§‡Øç‡Æ§‡ØÅ‡Æµ‡Æø‡Æü‡Øç‡Æü‡Øá‡Æ©‡Øç. ‡ÆÖ‡Æ§‡Æ©‡Øç ‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æ®‡Æø‡Æ≤‡Øà ‡Æá‡Æô‡Øç‡Æï‡Øá:", direct_dist_message: "üöç...üßç‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æö‡ØÅ‡ÆÆ‡Ææ‡Æ∞‡Øç <strong>{distance} ‡Æï‡Æø.‡ÆÆ‡ØÄ</strong> ‡Æ§‡Øä‡Æ≤‡Øà‡Æµ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ. ‡ÆÖ‡Æ§‡Øà ‡ÆÖ‡Æü‡Øà‡ÆØ ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ™‡ÆØ‡Æ£ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç <strong>{time} ‡Æ®‡Æø‡ÆÆ‡Æø‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç</strong>.", bus_arriving_message: "‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æµ‡Æ®‡Øç‡Æ§‡ØÅ‡Æï‡Øä‡Æ£‡Øç‡Æü‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ!", bus_details_title: "‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ #{busNumber} ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç", intercept_plan_title: "‡Æá‡Æü‡Øà‡ÆÆ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æ§‡Æø‡Æü‡Øç‡Æü‡ÆÆ‡Øç üó∫Ô∏è", intercept_stop_message: "‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡Æø‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡Æ±‡Øç‡Æï‡Ææ‡Æ© ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æµ‡Æ∞‡Æµ‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç: <strong>{stopName}</strong>", eta_user: "‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ", eta_bus: "‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ", search_again: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Øá‡Æü‡ØÅ", getting_location: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç...", location_confirmed: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ§‡Øç‡Æ§‡Øà <strong>{city}</strong> ‡ÆÖ‡Æ∞‡ØÅ‡Æï‡Øá ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ≥‡Øç‡Æ≥‡Øá‡Æ©‡Øç. ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç.", location_error: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ§‡Øç‡Æ§‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ± ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ©‡ØÅ‡ÆÆ‡Æ§‡Æø‡ÆØ‡Æ≥‡Æø‡Æ§‡Øç‡Æ§‡ØÅ ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.", no_live_location: "‡Æá‡Æ®‡Øç‡Æ§ ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æï‡Æø‡Æü‡Øà‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡ÆÖ‡Æ§‡ØÅ ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÖ‡Æ§‡Æ©‡Øç ‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æá‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æí‡Æ≥‡Æø‡Æ™‡Æ∞‡Æ™‡Øç‡Æ™‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.", bus_not_active: "‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ {busNumber} ‡Æï‡Æø‡Æü‡Øà‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ, ‡ÆÜ‡Æ©‡Ææ‡Æ≤‡Øç ‡ÆÖ‡Æ§‡ØÅ ‡Æ§‡Æ±‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æö‡Øá‡Æµ‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÖ‡Æ§‡Æ©‡Øç ‡Æ®‡Æø‡Æ≤‡Øà: {status}.", last_updated: "‡Æï‡Æü‡Øà‡Æö‡Æø‡ÆØ‡Ææ‡Æï‡Æ™‡Øç ‡Æ™‡ØÅ‡Æ§‡ØÅ‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ", driver_name: "‡Æì‡Æü‡Øç‡Æü‡ØÅ‡Æ®‡Æ∞‡Øç", driver_mobile: "‡Æì‡Æü‡Øç‡Æü‡ØÅ‡Æ®‡Æ∞‡Øç ‡ÆÆ‡Øä‡Æ™‡Øà‡∞≤‡±ç", available_seats: "‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç", total_seats: "‡ÆÆ‡Øä‡Æ§‡Øç‡Æ§ ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç", route: "‡Æ™‡Ææ‡Æ§‡Øà", number_plate: "‡Æµ‡Ææ‡Æï‡Æ© ‡Æé‡Æ£‡Øç", weather: "‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà", need_bus_context: "‡ÆÖ‡Æ§‡Æ©‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Øá‡Æü‡Øç‡Æ™‡Æ§‡Æ±‡Øç‡Æï‡ØÅ ‡ÆÆ‡ØÅ‡Æ©‡Øç, ‡Æí‡Æ∞‡ØÅ ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Øà‡Æï‡Øç ‡Æï‡Æ£‡Øç‡Æü‡ØÅ‡Æ™‡Æø‡Æü‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.", not_provided: "‡Æµ‡Æ¥‡Æô‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà", sms_title: "SMS ‡ÆÖ‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç üì±", phone_placeholder: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø ‡Æé‡Æ£‡Øç‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç...", sms_btn_text: "SMS ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ", sending_sms: "‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...", sms_sent: "‚úÖ SMS ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø‡Æï‡Æ∞‡ÆÆ‡Ææ‡Æï ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ!", sms_error: "‚ùå SMS ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.", unrecognized_bus_number: "‡Æ®‡Ææ‡Æ©‡Øç ‡Æ™‡Øá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æé‡Æ£‡Øç‡Æ£‡Øà ‡ÆÖ‡Æü‡Øà‡ÆØ‡Ææ‡Æ≥‡ÆÆ‡Øç ‡Æï‡Ææ‡Æ£‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç."
            }
        };
        
        // --- INITIALIZATION & EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMap();
            startNewSearch();
        });
        sendBtn.addEventListener('click', () => handleUserInput());
        userInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleUserInput(); });
        langSelect.addEventListener('change', startNewSearch);

        chatMessages.addEventListener('click', (e) => {
            if (e.target.classList.contains('search-again-btn')) startNewSearch();
            if (e.target.id === 'sms-btn') handleSendSms();
        });
        
        if (micBtn) {
            micBtn.addEventListener('click', () => {
                recognition.lang = langSelect.value;
                recognition.start();
            });
            recognition.onstart = () => micBtn.classList.add('is-listening');
            recognition.onend = () => micBtn.classList.remove('is-listening');
            recognition.onerror = (event) => micBtn.classList.remove('is-listening');
            recognition.onresult = (event) => {
                userInput.value = event.results[0][0].transcript;
                handleUserInput();
            };
        }

        function initializeMap() {
            mapInstance = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
            routeLayers.addTo(mapInstance);
        }

        // --- CHAT FLOW ---
        function startNewSearch() {
            if (trackingInterval) clearInterval(trackingInterval);
            chatMessages.innerHTML = '';
            currentBusData = null;
            Backendless.initApp(BACKENDLESS_APP_ID, BACKENDLESS_API_KEY);
            const lang = translations[langSelect.value] || translations['en-IN'];
            addBotMessage(lang.welcome);
            toggleInput(true);
            addBotMessage(lang.getting_location);
            getCurrentLocation().then(async (loc) => {
                userLocation = loc;
                updateUserMarker();
                const cityName = await getCityName(userLocation);
                const displayMessage = lang.location_confirmed.replace('{city}', cityName || 'your area');
                addBotMessage(displayMessage, false, cityName || '');
                toggleInput(false);
            }).catch(err => {
                addBotMessage(lang.location_error)
            });
        }

        async function handleUserInput() {
            const messageText = userInput.value.trim();
            if (!messageText) return;
            
            addUserMessage(messageText);
            userInput.value = '';
            toggleInput(true);
            await parseAndExecute(messageText);
            toggleInput(false);
        }
        
        function convertSpokenNumberToDigit(text) {
            const words = text.split(/(\s+)/); 
            const convertedWords = words.map(word => {
                const cleanWord = word.toLowerCase().replace(/[.,!?]/g, '');
                return numberWords[cleanWord] || word;
            });
            return convertedWords.join('');
        }
        
        async function parseAndExecute(text) {
            const lang = translations[langSelect.value] || translations['en-IN'];
            let processedText = convertSpokenNumberToDigit(text);

            const weatherKeywords = ['weather', '‡§Æ‡•å‡§∏‡§Æ', '‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç', '‡Æµ‡Ææ‡Æ©‡Æø‡Æ≤‡Øà'];
            const seatKeywords = ['seat', '‡§∏‡•Ä‡§ü', '‡∞∏‡±Ä‡∞ü‡±Å', '‡Æá‡Æü‡ÆÆ‡Øç', '‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç'];

            if (weatherKeywords.some(kw => text.toLowerCase().includes(kw))) {
                if (currentBusData) {
                    const weatherInfo = currentBusData.weather ? `<strong>${lang.weather}:</strong> ${currentBusData.weather}` : `<strong>${lang.weather}:</strong> ${lang.not_provided}`;
                    addBotMessage(weatherInfo);
                } else { addBotMessage(lang.need_bus_context); }
            } else if (seatKeywords.some(kw => text.toLowerCase().includes(kw))) {
                if (currentBusData) {
                    let seatText = `<strong>${lang.available_seats}:</strong> `;
                    seatText += (currentBusData.availableSeats !== null && currentBusData.availableSeats !== undefined) ? currentBusData.availableSeats : lang.not_provided;
                    addBotMessage(seatText);
                } else { addBotMessage(lang.need_bus_context); }
            } else {
                const busNumberMatch = processedText.match(/\d+/);
                if (busNumberMatch) {
                    await findAndDisplayBus(busNumberMatch[0]);
                } else {
                    addBotMessage(lang.unrecognized_bus_number);
                }
            }
        }
        
        async function findAndDisplayBus(busNumber) {
            const lang = translations[langSelect.value] || translations['en-IN'];
            addBotMessage(lang.searching);
            if (!userLocation) {
                addBotMessage(lang.location_error);
                addBotMessage(`<button class="search-again-btn">${lang.search_again}</button>`);
                return;
            }
            try {
                const queryBuilder = Backendless.DataQueryBuilder.create().setWhereClause(`busNumber = '${busNumber}'`);
                const buses = await Backendless.Data.of("Buses").find(queryBuilder);
                
                if (buses.length === 0) {
                    addBotMessage(lang.no_bus);
                } else {
                    const bus = buses[0];
                    if (bus.status === 'active') {
                        currentBusData = bus;
                        if (!currentBusData.currentLat || !currentBusData.currentLon) {
                            addBotMessage(lang.no_live_location);
                        } else {
                            addBotMessage(lang.bus_found);
                            await displayBusInfo(currentBusData);
                        }
                    } else {
                        addBotMessage(lang.bus_not_active.replace('{busNumber}', bus.busNumber).replace('{status}', bus.status));
                    }
                }
            } catch (error) {
                console.error("Error finding bus:", error);
            } finally {
                addBotMessage(`<button class="search-again-btn">${lang.search_again}</button>`);
            }
        }

        async function displayBusInfo(bus) {
            const messageId = `bus-info-${bus.objectId}`;
            if (document.getElementById(messageId)) document.getElementById(messageId).remove();
            
            const interceptStop = await findBestInterceptStop(bus, userLocation);
            
            const messageContainer = document.createElement('div');
            messageContainer.id = messageId;
            messageContainer.innerHTML = `<div class="direct-dist-container"></div><div class="bus-details-container"></div><div class="intercept-plan-container"></div><div class="notification-container"></div>`;
            addBotMessage(messageContainer.outerHTML, true); // Don't speak the container
            
            updateLiveElements(bus, interceptStop, messageId);
            updateMap(bus, interceptStop);

            if (trackingInterval) clearInterval(trackingInterval);
            trackingInterval = setInterval(async () => {
                const latestBus = await Backendless.Data.of("Buses").findById(bus.objectId);
                if (latestBus) {
                    currentBusData = latestBus;
                    const newInterceptStop = await findBestInterceptStop(latestBus, userLocation);
                    updateLiveElements(latestBus, newInterceptStop, messageId);
                    updateMap(latestBus, newInterceptStop);
                }
            }, 30000);
        }

        async function handleSendSms() {
            const lang = translations[langSelect.value] || translations['en-IN'];
            const phoneInput = document.getElementById('phone-input');
            const smsBtn = document.getElementById('sms-btn');
            const statusDiv = document.getElementById('sms-status');
        
            const phoneNumber = phoneInput.value.trim();
            if (!phoneNumber || !/^\+?[1-9]\d{1,14}$/.test(phoneNumber)) {
                alert('Please enter a valid phone number, including the country code (e.g., +919876543210).');
                phoneInput.focus();
                return;
            }
        
            if (!currentBusData) {
                statusDiv.textContent = 'Error: Bus data not found.';
                return;
            }
        
            smsBtn.disabled = true;
            smsBtn.textContent = lang.sending_sms;
            statusDiv.textContent = '';
        
            const busDetails = {
                busNumber: currentBusData.busNumber,
                route: `${currentBusData.source || '?'} -> ${currentBusData.destination || '?'}`,
                availableSeats: currentBusData.availableSeats,
                weather: currentBusData.weather,
                lat: currentBusData.currentLat,
                lon: currentBusData.currentLon
            };

            const langCode = langSelect.value;
        
            try {
                const response = await fetch('/send_sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        bus_details: busDetails,
                        language: langCode
                    })
                });
        
                const result = await response.json();
                if (response.ok && result.success) {
                    statusDiv.innerHTML = `<span style="color: green;">${lang.sms_sent}</span>`;
                } else {
                    statusDiv.innerHTML = `<span style="color: red;">${lang.sms_error} ${result.error || ''}</span>`;
                }
            } catch (error) {
                console.error("Fetch API Error:", error);
                statusDiv.innerHTML = `<span style="color: red;">${lang.sms_error}</span>`;
            } finally {
                smsBtn.disabled = false;
                smsBtn.textContent = lang.sms_btn_text;
            }
        }

        // --- UI & MAP UPDATES ---
        function getTranslatedRoute(source, dest, lang) {
            if (!source || !dest) return '';
            const tSource = (placeNameTranslations[source] && placeNameTranslations[source][lang]) || source;
            const tDest = (placeNameTranslations[dest] && placeNameTranslations[dest][lang]) || dest;
            return `${tSource} to ${tDest}`;
        }
        
        async function updateLiveElements(bus, interceptStop, messageId) {
            const lang = translations[langSelect.value] || translations['en-IN'];
            const infoEl = document.getElementById(messageId);
            if (!infoEl) return;
            
            const directDistContainer = infoEl.querySelector('.direct-dist-container');
            const directRoute = await getORSRoute([userLocation.longitude, userLocation.latitude], [bus.currentLon, bus.currentLat]);
            if (directRoute && directRoute.features) {
                const summary = directRoute.features[0].properties.summary;
                const distKm = (summary.distance / 1000);
                const timeMin = Math.round(summary.duration / 60);
                directDistContainer.innerHTML = distKm < 0.15 ? lang.bus_arriving_message : lang.direct_dist_message.replace('{distance}', distKm.toFixed(1)).replace('{time}', timeMin);
            }

            const detailsContainer = infoEl.querySelector('.bus-details-container');
            const translatedRoute = getTranslatedRoute(bus.source, bus.destination, langSelect.value);
            let detailsHtml = `<div class="section-title">${lang.bus_details_title.replace('{busNumber}', bus.busNumber)}</div><ul class="details-list">`;
            detailsHtml += `<li><strong>${lang.route}:</strong> <span class="details-list-value">${translatedRoute}</span></li>`;
            if (bus.numberPlate) detailsHtml += `<li><strong>${lang.number_plate}:</strong> <span class="details-list-value">${bus.numberPlate}</span></li>`;
            if (bus.driverName) detailsHtml += `<li><strong>${lang.driver_name}:</strong> <span class="details-list-value">${bus.driverName}</span></li>`;
            if (bus.driverMobile) detailsHtml += `<li><strong>${lang.driver_mobile}:</strong> <span class="details-list-value">${bus.driverMobile}</span></li>`;
            if (bus.availableSeats !== null && bus.availableSeats !== undefined) detailsHtml += `<li><strong>${lang.available_seats}:</strong> <span class="details-list-value">${bus.availableSeats}</span></li>`;
            if (bus.totalSeats) detailsHtml += `<li><strong>${lang.total_seats}:</strong> <span class="details-list-value">${bus.totalSeats}</span></li>`;
            if (bus.weather) detailsHtml += `<li><strong>${lang.weather}:</strong> <span class="details-list-value">${bus.weather}</span></li>`;
            detailsHtml += `<li><strong>${lang.last_updated}:</strong> <span class="details-list-value">${formatTimeAgo(bus.updated)}</span></li>`;
            detailsHtml += `</ul>`;
            detailsContainer.innerHTML = detailsHtml;

            const interceptContainer = infoEl.querySelector('.intercept-plan-container');
            if (interceptStop) {
                const etaUser = await getORSRoute([userLocation.longitude, userLocation.latitude], interceptStop.coords);
                const etaBus = await getORSRoute([bus.currentLon, bus.currentLat], interceptStop.coords);
                let interceptHtml = `<div class="section-title">${lang.intercept_plan_title}</div><p>${lang.intercept_stop_message.replace('{stopName}', interceptStop.name)}</p><div class="info-grid">`;
                interceptHtml += `<div class="info-card"><h3>üìç ${lang.eta_user}</h3><p>${etaUser ? Math.round(etaUser.features[0].properties.summary.duration / 60) + ' min' : '--'}</p></div>`;
                interceptHtml += `<div class="info-card"><h3>üöå ${lang.eta_bus}</h3><p>${etaBus ? Math.round(etaBus.features[0].properties.summary.duration / 60) + ' min' : '--'}</p></div>`;
                interceptHtml += `</div>`;
                interceptContainer.innerHTML = interceptHtml;
            } else { interceptContainer.innerHTML = ''; }

            const notificationContainer = infoEl.querySelector('.notification-container');
            if (notificationContainer) {
                notificationContainer.innerHTML = `
                    <div class="section-title">${lang.sms_title}</div>
                    <div class="flex space-x-2 my-2">
                        <input type="tel" id="phone-input" placeholder="${lang.phone_placeholder}" class="flex-grow border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <button id="sms-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700">${lang.sms_btn_text}</button>
                    </div>
                    <div id="sms-status" class="text-sm mt-1"></div>
                `;
            }
            
            speak(infoEl.innerHTML, langSelect.value);
        }
        
        // --- UTILITY FUNCTIONS ---
        let voices = [];
        function populateVoiceList() {
            if(typeof speechSynthesis === 'undefined') {
                return;
            }
            voices = speechSynthesis.getVoices();
        }
        populateVoiceList();
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        function speak(htmlContent, lang) {
            if (!htmlContent || !('speechSynthesis' in window)) return;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const cleanText = tempDiv.textContent || tempDiv.innerText || "";
            if (!cleanText.trim()) return;

            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(cleanText.trim());
            utterance.lang = lang;
            
            const desiredVoice = voices.find(voice => voice.lang === lang);
            if (desiredVoice) {
                utterance.voice = desiredVoice;
            } else {
                console.warn(`No voice found for language: ${lang}. Using browser default.`);
            }
            
            window.speechSynthesis.speak(utterance);
        }

        function addBotMessage(content, isHtmlContainer = false, textToSpeak = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message bot-message`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content;
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            scrollToBottom();
            
            const speechText = textToSpeak !== null ? textToSpeak : content;
            if (!isHtmlContainer) {
                speak(speechText, langSelect.value);
            }
        }
        
        function updateMap(bus, stop) { if (!mapInstance) return; routeLayers.clearLayers(); const busLatLng = [bus.currentLat, bus.currentLon]; if (busMarker) busMarker.setLatLng(busLatLng); else busMarker = L.marker(busLatLng, { icon: L.icon({ iconUrl: 'https://img.icons8.com/plasticine/100/000000/bus.png', iconSize: [40, 40] }) }).addTo(mapInstance).bindPopup(`Bus #${bus.busNumber}`); const bounds = [busLatLng, [userLocation.latitude, userLocation.longitude]]; if (stop) { const stopLatLng = [stop.coords[1], stop.coords[0]]; if (stopMarker) stopMarker.setLatLng(stopLatLng); else stopMarker = L.marker(stopLatLng).addTo(mapInstance); stopMarker.setPopupContent(`Intercept at: ${stop.name}`); bounds.push(stopLatLng); drawRouteOnMap([userLocation.longitude, userLocation.latitude], stop.coords, '#3b82f6'); drawRouteOnMap([bus.currentLon, bus.currentLat], stop.coords, '#10b981'); } mapInstance.fitBounds(bounds, { padding: [50, 50] }); }
        function updateUserMarker() { if (!mapInstance || !userLocation) return; const userLatLng = [userLocation.latitude, userLocation.longitude]; if (userMarker) userMarker.setLatLng(userLatLng); else userMarker = L.marker(userLatLng, { icon: L.icon({ iconUrl: 'https://img.icons8.com/color/48/000000/marker.png', iconSize: [40, 40] }) }).addTo(mapInstance).bindPopup("Your Location"); mapInstance.setView(userLatLng, 13); }
        async function findBestInterceptStop(bus, userLoc) { let stopNames = [bus.source, ...Array.from({ length: 10 }, (_, i) => bus[`stop${i+1}`]), bus.destination].filter(Boolean); const geocodePromises = stopNames.map(name => getORSGeocode(name)); let allStops = (await Promise.all(geocodePromises)).map((r, i) => r.length > 0 ? { name: stopNames[i], coords: r[0].geometry.coordinates, originalIndex: i } : null).filter(Boolean); if (allStops.length === 0) return null; const busToStopsResults = await Promise.all(allStops.map(stop => getORSRoute([bus.currentLon, bus.currentLat], stop.coords))); let minEta = Infinity, nextStopIndex = -1; busToStopsResults.forEach((route, index) => { if (route && route.features) { const duration = route.features[0].properties.summary.duration; if (duration < minEta) { minEta = duration; nextStopIndex = allStops[index].originalIndex; } } }); const upcomingStops = allStops.filter(stop => stop.originalIndex >= nextStopIndex); if (upcomingStops.length === 0) return allStops.find(s => s.name === bus.destination) || null; const userToUpcomingStopsResults = await Promise.all(upcomingStops.map(stop => getORSRoute([userLoc.longitude, userLoc.latitude], stop.coords))); let bestStop = null, minUserDist = Infinity; userToUpcomingStopsResults.forEach((route, index) => { if (route && route.features) { const distance = route.features[0].properties.summary.distance; if (distance < minUserDist) { minUserDist = distance; bestStop = upcomingStops[index]; } } }); return bestStop; }
        async function getCityName(coords) { if (!ORS_API_KEY || ORS_API_KEY.includes('YOUR_')) return null; const url = `https://api.openrouteservice.org/geocode/reverse?api_key=${ORS_API_KEY}&point.lon=${coords.longitude}&point.lat=${coords.latitude}`; try { const response = await fetch(url); const data = await response.json(); if (data.features && data.features.length > 0) { return data.features[0].properties.locality || data.features[0].properties.county; } return null; } catch (e) { return null; } }
        async function getORSGeocode(placeName) { if (!ORS_API_KEY || ORS_API_KEY.includes('YOUR_')) return []; try { return (await (await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(placeName)}&boundary.country=IND`)).json()).features || []; } catch (e) { return []; } }
        async function getORSRoute(start, end) { if (!ORS_API_KEY || ORS_API_KEY.includes('YOUR_')) return null; try { const r = await fetch(`https://api.openrouteservice.org/v2/directions/driving-car/geojson`, { method: 'POST', headers: { 'Authorization': ORS_API_KEY, 'Content-Type': 'application/json' }, body: JSON.stringify({ coordinates: [start, end] }) }); return await r.json(); } catch (e) { return null; } }
        async function drawRouteOnMap(start, end, color) { const d = await getORSRoute(start, end); if (d && d.features) L.geoJSON(d, { style: { color, weight: 5, opacity: 0.7 } }).addTo(routeLayers); }
        function addUserMessage(text) { const m = document.createElement('div'); m.className = `message user-message`; m.innerHTML = `<div class="message-content">${text}</div>`; chatMessages.appendChild(m); scrollToBottom(); }
        function toggleInput(disabled) { userInput.disabled = disabled; sendBtn.disabled = disabled; }
        function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }
        function formatTimeAgo(timestamp) { if (!timestamp) return '...'; const s = Math.floor((new Date() - new Date(timestamp)) / 1000); if (s < 30) return `just now`; if (s < 60) return `${s}s ago`; const m = Math.floor(s / 60); if (m < 60) return `${m}m ago`; const h = Math.floor(m / 60); if (h < 24) return `${h}h ago`; return `${Math.floor(h / 24)}d ago`; }
        function getCurrentLocation() { return new Promise((resolve, reject) => { if (!navigator.geolocation) { reject(new Error("Geolocation is not supported.")); } navigator.geolocation.getCurrentPosition(p => resolve(p.coords), reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); }); }
    </script>
</body>
</html>